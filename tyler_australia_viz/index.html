<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tyler, The Creator in Australia — HD Visualisation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    :root { --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --border:#e2e8f0; }
    *{box-sizing:border-box}
    body{margin:24px;background:var(--bg);color:var(--ink);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    header, footer{max-width:1200px;margin:0 auto}
    header h1{margin:0 0 6px 0;font-size:28px}
    header p{margin:0;color:var(--muted)}
    .grid{max-width:1200px;margin:22px auto;display:grid;gap:22px}
    @media(min-width:1100px){ .grid{grid-template-columns: 1fr 1fr;} }
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(15,23,42,0.08);border:1px solid var(--border);}
    .card h2{margin:6px 0 12px 0;font-size:18px}
    .wide{grid-column: 1 / -1}
    .legend-chip{display:inline-block;width:10px;height:10px;border-radius:3px;margin-right:6px;vertical-align:middle}
  </style>
</head>
<body>
  <header>
    <h1>Tyler, The Creator in Australia</h1>
    <p>Style, lyrics, and audience across states — corrected map and enhanced visuals</p>
  </header>

  <!-- Inline Australia states GeoJSON -->
  <script>
    const AUS_GEO = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"STATE_NAME":"New South Wales"},"geometry":{"type":"Polygon","coordinates":[[[141,-28],[153.6,-28],[153.6,-37.5],[141,-37.5],[141,-28]]]}},
        {"type":"Feature","properties":{"STATE_NAME":"Victoria"},"geometry":{"type":"Polygon","coordinates":[[[141,-37.5],[150,-37.5],[150,-39.2],[141,-39.2],[141,-37.5]]]}},
        {"type":"Feature","properties":{"STATE_NAME":"Queensland"},"geometry":{"type":"Polygon","coordinates":[[[138,-10.5],[153.6,-10.5],[153.6,-28],[138,-28],[138,-10.5]]]}},
        {"type":"Feature","properties":{"STATE_NAME":"Western Australia"},"geometry":{"type":"Polygon","coordinates":[[[112,-14],[129,-14],[129,-35],[112,-35],[112,-14]]]}},
        {"type":"Feature","properties":{"STATE_NAME":"South Australia"},"geometry":{"type":"Polygon","coordinates":[[[129,-26],[141,-26],[141,-38],[129,-38],[129,-26]]]}},
        {"type":"Feature","properties":{"STATE_NAME":"Tasmania"},"geometry":{"type":"Polygon","coordinates":[[[144,-39.2],[149,-39.2],[149,-43.8],[144,-43.8],[144,-39.2]]]}}
      ]
    };
  </script>

  <main class="grid">
    <section class="card"><h2>Style Evolution</h2><div id="chart1"></div></section>
    <section class="card"><h2>Feature Heatmap</h2><div id="chart2"></div></section>
    <section class="card"><h2>Lyric Themes</h2><div id="chart3"></div></section>
    <section class="card wide"><h2>Australian Audience Map</h2><div id="chart4"></div></section>
    <section class="card"><h2>Plays vs Listeners</h2><div id="chart5"></div></section>
    <section class="card"><h2>Feature Rank (Bump)</h2><div id="chart6"></div></section>
  </main>

  <script>
    const albumColorScale = {
      "domain": ["Flower Boy","IGOR","Call Me If You Get Lost"],
      "range": ["#f59e0b","#f472b6","#10b981"]
    };

    // 1) Style line chart
    vegaEmbed("#chart1", {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "width":550,"height":300,
      "data":{"url":"tyler_audio_features_aus.json"},
      "mark":{"type":"line","point":true},
      "encoding":{
        "x":{"field":"year","type":"ordinal"},
        "y":{"field":"value","type":"quantitative"},
        "color":{"field":"album","scale":albumColorScale},
        "tooltip":["album","year","metric","value"]
      }
    }, {actions:false});

    // 2) Heatmap
    vegaEmbed("#chart2", {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "width":550,"height":300,
      "data":{"url":"tyler_audio_features_aus.json"},
      "mark":"rect",
      "encoding":{
        "x":{"field":"album","type":"nominal"},
        "y":{"field":"metric","type":"nominal"},
        "color":{"field":"value","type":"quantitative"},
        "tooltip":["album","metric","value"]
      }
    }, {actions:false});

    // 3) Lyric chart
    vegaEmbed("#chart3", {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "width":550,"height":300,
      "data":{"url":"tyler_lyrics_aus.json"},
      "mark":"bar",
      "encoding":{
        "x":{"field":"word","type":"nominal","axis":{"labelAngle":0}},
        "y":{"field":"count","type":"quantitative"},
        "color":{"field":"album","scale":albumColorScale},
        "tooltip":["album","word","count","popularity_AUS"]
      }
    }, {actions:false});

    // 4) FIXED MAP
    async function renderAUSMap(){
      const resp = await fetch("aus_audience_states.json");
      const data = await resp.json();
      const map = JSON.parse(JSON.stringify(AUS_GEO));
      const mapIndex = new Map(data.map(d=>[d.state,d]));
      map.features.forEach(f=>{
        const m = mapIndex.get(f.properties.STATE_NAME);
        if(m){Object.assign(f.properties,m);}
        else{f.properties.listeners=0;f.properties.plays=0;}
      });
      const spec = {
        "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
        "width":1100,"height":600,
        "projection":{"type":"mercator","center":[134,-27],"scale":900},
        "layer":[
          {"data":{"graticule":{"step":[10,10]}},
           "mark":{"type":"geoshape","stroke":"#ddd"}},
          {"data":{"values":map,"format":{"type":"geojson"}},
           "mark":{"type":"geoshape","stroke":"#222"},
           "encoding":{
             "color":{"field":"properties.listeners","type":"quantitative","scale":{"scheme":"orangered"}},
             "tooltip":[
               {"field":"properties.STATE_NAME","title":"State"},
               {"field":"properties.listeners","title":"Listeners"},
               {"field":"properties.plays","title":"Plays"},
               {"field":"properties.top_song","title":"Top Song"}
             ]
           }},
          {"data":{"values":data},
           "mark":{"type":"circle","opacity":0.8,"stroke":"#111","strokeWidth":0.5},
           "encoding":{
             "longitude":{"field":"lon"},"latitude":{"field":"lat"},
             "size":{"field":"listeners","scale":{"range":[80,1200]}},
             "color":{"field":"plays","type":"quantitative","scale":{"scheme":"blues"}},
             "tooltip":["state","listeners","plays"]
           }},
          {"data":{"values":data},
           "mark":{"type":"text","dy":-10,"fontSize":12,"fontWeight":"bold"},
           "encoding":{"longitude":{"field":"lon"},"latitude":{"field":"lat"},"text":{"field":"abbr"}}}
        ]
      };
      vegaEmbed("#chart4", spec, {actions:false});
    }
    renderAUSMap();

    // 5) Scatter
    vegaEmbed("#chart5", {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "width":550,"height":300,
      "data":{"url":"aus_audience_states.json"},
      "mark":"point",
      "encoding":{
        "x":{"field":"listeners","type":"quantitative"},
        "y":{"field":"plays","type":"quantitative"},
        "tooltip":["state","listeners","plays"]
      }
    }, {actions:false});

    // 6) Bump
    fetch("tyler_audio_features_aus.json").then(r=>r.json()).then(rows=>{
      const metrics=["Danceability","Energy","Valence"], arr=[];
      metrics.forEach(m=>{
        const sorted=rows.filter(d=>d.metric===m).sort((a,b)=>b.value-a.value);
        sorted.forEach((d,i)=>arr.push({metric:m,album:d.album,rank:i+1}));
      });
      const spec={
        "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
        "width":550,"height":300,
        "data":{"values":arr},
        "mark":{"type":"line","point":true},
        "encoding":{
          "x":{"field":"metric","type":"ordinal"},
          "y":{"field":"rank","type":"quantitative","scale":{"reverse":true}},
          "color":{"field":"album","scale":albumColorScale},
          "tooltip":["album","metric","rank"]
        }
      };
      vegaEmbed("#chart6", spec, {actions:false});
    });
  </script>
</body>
</html>
