<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AUS Audience Map — Minimal Working Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Vega stack -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    body{margin:24px;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
  </style>
</head>
<body>
  <h2>Australian Audience Map — Minimal Working Example</h2>
  <div id="map" style="max-width:1200px"></div>

  <script>
    // 1) 你的州数据（已贴入）
    const AUS_METRICS = [
      {"state":"New South Wales","abbr":"NSW","listeners":82000,"plays":3150000,"top_song":"EARFQUAKE","lat":-33.8688,"lon":151.2093},
      {"state":"Victoria","abbr":"VIC","listeners":76000,"plays":2890000,"top_song":"See You Again","lat":-37.8136,"lon":144.9631},
      {"state":"Queensland","abbr":"QLD","listeners":52000,"plays":1880000,"top_song":"WUSYANAME","lat":-27.4698,"lon":153.0251},
      {"state":"Western Australia","abbr":"WA","listeners":28000,"plays":990000,"top_song":"I THINK","lat":-31.9523,"lon":115.8613},
      {"state":"South Australia","abbr":"SA","listeners":18000,"plays":640000,"top_song":"CORSO","lat":-34.9285,"lon":138.6007},
      {"state":"Tasmania","abbr":"TAS","listeners":9000,"plays":320000,"top_song":"EARFQUAKE","lat":-42.8821,"lon":147.3272}
    ];

    // 2) 澳洲简化州界（矩形近似；属性 STATE_NAME 用来匹配）
    const AUS_GEO = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"STATE_NAME":"New South Wales"},"geometry":{"type":"Polygon","coordinates":[[[141,-28],[153.6,-28],[153.6,-37.5],[141,-37.5],[141,-28]]]}},
        {"type":"Feature","properties":{"STATE_NAME":"Victoria"},"geometry":{"type":"Polygon","coordinates":[[[141,-37.5],[150,-37.5],[150,-39.2],[141,-39.2],[141,-37.5]]]}},
        {"type":"Feature","properties":{"STATE_NAME":"Queensland"},"geometry":{"type":"Polygon","coordinates":[[[138,-10.5],[153.6,-10.5],[153.6,-28],[138,-28],[138,-10.5]]]}},
        {"type":"Feature","properties":{"STATE_NAME":"Western Australia"},"geometry":{"type":"Polygon","coordinates":[[[112,-14],[129,-14],[129,-35],[112,-35],[112,-14]]]}},
        {"type":"Feature","properties":{"STATE_NAME":"South Australia"},"geometry":{"type":"Polygon","coordinates":[[[129,-26],[141,-26],[141,-38],[129,-38],[129,-26]]]}},
        {"type":"Feature","properties":{"STATE_NAME":"Tasmania"},"geometry":{"type":"Polygon","coordinates":[[[144,-39.2],[149,-39.2],[149,-43.8],[144,-43.8],[144,-39.2]]]}}
      ]
    };

    // 3) 在 JS 里把 listeners/plays 等合并进每个州的 properties（最稳妥，不用 lookup）
    const mergedGeo = JSON.parse(JSON.stringify(AUS_GEO));
    const byState = new Map(AUS_METRICS.map(d => [d.state, d]));
    mergedGeo.features.forEach(f => {
      const m = byState.get(f.properties.STATE_NAME);
      if (m) {
        f.properties.listeners = m.listeners;
        f.properties.plays = m.plays;
        f.properties.top_song = m.top_song;
        f.properties.abbr = m.abbr;
      } else {
        f.properties.listeners = 0;
        f.properties.plays = 0;
      }
    });

    // 4) Vega-Lite 规格：底图 graticule + 州面 choropleth + 圆点 + 州缩写文字
    const spec = {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "width": 1100, "height": 600,
      "projection":{"type":"mercator","center":[134,-27],"scale":900},
      "layer":[
        {"data":{"graticule":{"step":[10,10]}},
         "mark":{"type":"geoshape","stroke":"#e2e8f0","strokeWidth":0.6}},
        {
          "data":{"values": mergedGeo, "format":{"type":"geojson"}},
          "mark":{"type":"geoshape","stroke":"#1f2937","strokeWidth":0.7},
          "encoding":{
            "color":{"field":"properties.listeners","type":"quantitative","title":"Listeners",
                     "scale":{"scheme":"orangered","nice":true}},
            "tooltip":[
              {"field":"properties.STATE_NAME","title":"State"},
              {"field":"properties.listeners","title":"Listeners"},
              {"field":"properties.plays","title":"Plays"},
              {"field":"properties.top_song","title":"Top song"}
            ]
          }
        },
        {
          "data":{"values": AUS_METRICS},
          "mark":{"type":"circle","opacity":0.85,"stroke":"#0f172a","strokeWidth":0.6},
          "encoding":{
            "longitude":{"field":"lon","type":"quantitative"},
            "latitude":{"field":"lat","type":"quantitative"},
            "size":{"field":"listeners","type":"quantitative","title":"Listeners","scale":{"range":[60,1400]}},
            "color":{"field":"plays","type":"quantitative","title":"Plays","scale":{"scheme":"blues","nice":true}},
            "tooltip":[{"field":"state"},{"field":"listeners"},{"field":"plays"}]
          }
        },
        {
          "data":{"values": AUS_METRICS},
          "mark":{"type":"text","dy":-10,"fontSize":12,"fontWeight":"700",
                  "color":"#0f172a","stroke":"white","strokeWidth":2,"strokeOpacity":0.85},
          "encoding":{"longitude":{"field":"lon"}, "latitude":{"field":"lat"}, "text":{"field":"abbr"}}
        }
      ]
    };

    vegaEmbed("#map", spec, {actions:false});
  </script>
</body>
</html>
