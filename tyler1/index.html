<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tyler, The Creator in Australia — Advanced Visualisation (Fixed)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Vega stack -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    :root { --bg:#f7f7fb; --card:#ffffff; --ink:#14151a; --muted:#6b7280; }
    *{box-sizing:border-box}
    body{margin:24px;background:var(--bg);color:var(--ink);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    header, footer{max-width:1200px;margin:0 auto}
    header h1{margin:0 0 6px 0;font-size:28px}
    header p{margin:0;color:var(--muted)}
    .grid{max-width:1200px;margin:22px auto;display:grid;gap:22px}
    @media(min-width:1100px){ .grid{grid-template-columns: 1fr 1fr;} }
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.07)}
    .card h2{margin:6px 0 12px 0;font-size:18px}
    .wide{grid-column: 1 / -1}
    .controls{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .legend-chip{display:inline-block;width:10px;height:10px;border-radius:3px;margin-right:6px;vertical-align:middle}
  </style>
</head>
<body>
  <header>
    <h1>Tyler, The Creator in Australia</h1>
    <p>Style, lyrics, and audience across states — album-thematic colours & corrected scales.</p>
  </header>

  <main class="grid">
    <!-- 1) Time series with temporal axis + album colours -->
    <section class="card">
      <div class="controls">
        <h2 style="margin-right:auto">Style Evolution (AUS)</h2>
        <label for="metricSel">Metric:</label>
        <select id="metricSel">
          <option>Danceability</option>
          <option>Energy</option>
          <option>Valence</option>
        </select>
      </div>
      <div id="chart1"></div>
    </section>

    <!-- 2) Heatmap overview -->
    <section class="card">
      <h2>Album × Feature Heatmap</h2>
      <div id="chart2"></div>
    </section>

    <!-- 3) Lyrics themes -->
    <section class="card">
      <h2>Lyric Themes (AUS Preference)</h2>
      <div id="chart3"></div>
    </section>

    <!-- 4) Australia map -->
    <section class="card wide">
      <h2>Australian Audience by State (Choropleth + Symbols)</h2>
      <div id="chart4"></div>
    </section>

    <!-- 5) Plays vs Listeners -->
    <section class="card">
      <h2>Plays vs Listeners (by State)</h2>
      <div id="chart5"></div>
    </section>

    <!-- 6) Bump chart -->
    <section class="card">
      <h2>Feature Ranking by Album (Bump)</h2>
      <div id="chart6"></div>
    </section>
  </main>

  <footer>
    <p style="color:#9ca3af;font-size:13px">
      Colours — Flower Boy <span class="legend-chip" style="background:#f59e0b"></span>,
      IGOR <span class="legend-chip" style="background:#f472b6"></span>,
      CMIYGL <span class="legend-chip" style="background:#10b981"></span>
    </p>
  </footer>

  <script>
    // ====== SETTINGS ======
    // 如果你下载了澳洲州界文件为 aus_states.geojson，设为 true
    const USE_LOCAL_AUS_STATES = false;
    const AUS_STATES_URL = USE_LOCAL_AUS_STATES
      ? "aus_states.geojson"
      : "https://raw.githubusercontent.com/rowanhogan/australian-states/master/states.geojson";

    // album colours
    const albumColorScale = {
      "domain": ["Flower Boy","IGOR","Call Me If You Get Lost"],
      "range": ["#f59e0b","#f472b6","#10b981"]
    };

    // 1) Style time series — FIX: temporal axis + sane scales
    function styleSpec(metric="Danceability"){
      return {
        "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
        "data":{"url":"tyler_audio_features_aus.json"},
        "transform":[
          {"filter": `datum.metric == "${metric}"`},
          {"calculate": "toDate(datum.year + '-01-01')", "as":"date"}
        ],
        "layer":[
          {
            "mark":{"type":"line","interpolate":"monotone","strokeWidth":2},
            "encoding":{
              "x":{"field":"date","type":"temporal","title":"Year","axis":{"format":"%Y"}},
              "y":{"field":"value","type":"quantitative","title": metric,
                   "scale":{"nice": true, "zero": false}},
              "color":{"value":"#111827"}
            }
          },
          {
            "mark":{"type":"point","filled":true,"size":110,"stroke":"#111827","strokeWidth":1},
            "encoding":{
              "x":{"field":"date","type":"temporal"},
              "y":{"field":"value","type":"quantitative"},
              "color":{"field":"album","type":"nominal","scale": albumColorScale},
              "tooltip":[{"field":"album"},{"field":"year"},{"field":"value"}]
            }
          },
          {
            "data":{"values":[{"year":2019},{"year":2021}]},
            "transform":[{"calculate":"toDate(datum.year + '-01-01')","as":"rdate"}],
            "mark":{"type":"rule","strokeDash":[6,4],"color":"#9ca3af"},
            "encoding":{"x":{"field":"rdate","type":"temporal"}}
          }
        ]
      }
    }
    const el1 = document.getElementById('chart1');
    const sel = document.getElementById('metricSel');
    function renderStyle(){ vegaEmbed(el1, styleSpec(sel.value), {actions:false}); }
    sel.addEventListener('change', renderStyle);
    renderStyle();

    // 2) Heatmap — FIX: explicit colour domain & scheme
    const spec2 = {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "data":{"url":"tyler_audio_features_aus.json"},
      "transform":[{"aggregate":[{"op":"mean","field":"value","as":"val"}],"groupby":["album","metric"]}],
      "mark":{"type":"rect","cornerRadius":3},
      "encoding":{
        "x":{"field":"album","type":"nominal","title":"Album","axis":{"labelAngle":0}},
        "y":{"field":"metric","type":"nominal","title":"Feature"},
        "color":{"field":"val","type":"quantitative","title":"Mean",
                 "scale":{"domain":[0.55,0.9], "scheme":"tealblues"}},
        "tooltip":[{"field":"album"},{"field":"metric"},{"field":"val"}]
      }
    };
    vegaEmbed("#chart2", spec2, {actions:false});

    // 3) Lyrics — FIX: y starts at 0, legend-filter, opacity domain
    const spec3 = {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "data":{"url":"tyler_lyrics_aus.json"},
      "params":[{"name":"albumSel","select":{"type":"point","fields":["album"]},"bind":"legend"}],
      "mark":{"type":"bar","cornerRadiusEnd":4},
      "encoding":{
        "x":{"field":"word","type":"nominal","title":"Keyword","sort":"-y","axis":{"labelAngle":0}},
        "y":{"field":"count","type":"quantitative","title":"Frequency","scale":{"zero": true, "nice": true}},
        "color":{"field":"album","type":"nominal","scale": albumColorScale, "legend":{"title":"Album (click to filter)"}}},
        "opacity":{"field":"popularity_AUS","type":"quantitative","title":"AUS preference",
                   "scale":{"domain":[0.6,0.95]}},
        "tooltip":[{"field":"album"},{"field":"word"},{"field":"count"},{"field":"popularity_AUS","title":"AUS preference"}]
      ,
      "transform":[{"filter":{"param":"albumSel"}}]
    };
    vegaEmbed("#chart3", spec3, {actions:false});

    // 4) Australia map — FIX: local/remote geojson, tuned symbol sizes & colour scales
    const spec4 = {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "width": 1100,
      "height": 600,
      "projection":{"type":"mercator","center":[134,-27],"scale": 900},
      "layer":[
        {"data":{"graticule":{"step":[10,10]}},"mark":{"type":"geoshape","stroke":"#e5e7eb","strokeWidth":0.6}},
        {
          "data":{"url": AUS_STATES_URL, "format":{"type":"geojson"}},
          "transform":[
            {"lookup":"properties.STATE_NAME",
             "from":{"data":{"url":"aus_audience_states.json"},
                     "key":"state","fields":["listeners","plays","abbr","top_song"]}}
          ],
          "mark":{"type":"geoshape","stroke":"#374151","strokeWidth":0.7},
          "encoding":{
            "color":{"field":"listeners","type":"quantitative","title":"Listeners",
                     "scale":{"scheme":"orangered", "nice": true}},
            "tooltip":[
              {"field":"properties.STATE_NAME","title":"State"},
              {"field":"listeners"},{"field":"plays"},{"field":"top_song","title":"Top song"}
            ]
          }
        },
        {
          "data":{"url":"aus_audience_states.json"},
          "mark":{"type":"circle","opacity":0.85,"stroke":"#111827","strokeWidth":0.6},
          "encoding":{
            "longitude":{"field":"lon","type":"quantitative"},
            "latitude":{"field":"lat","type":"quantitative"},
            "size":{"field":"listeners","type":"quantitative","title":"Listeners",
                    "scale":{"range":[50, 1200]}},
            "color":{"field":"plays","type":"quantitative","title":"Plays",
                     "scale":{"scheme":"blues","nice": true}},
            "tooltip":[{"field":"state"},{"field":"listeners"},{"field":"plays"}]
          }
        },
        {
          "data":{"url":"aus_audience_states.json"},
          "mark":{"type":"text","fontSize":12,"fontWeight":"700","dy":-10,
                  "color":"#111827","stroke":"white","strokeWidth":2,"strokeOpacity":0.85},
          "encoding":{"longitude":{"field":"lon"}, "latitude":{"field":"lat"}, "text":{"field":"abbr"}}
        }
      ]
    };
    vegaEmbed("#chart4", spec4, {actions:false});

    // 5) Scatter + regression — FIX: axes start at 0, nice ticks
    const spec5 = {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "data":{"url":"aus_audience_states.json"},
      "layer":[
        {"mark":{"type":"point","filled":true,"size":140},
         "encoding":{
           "x":{"field":"listeners","type":"quantitative","title":"Listeners","scale":{"zero": true, "nice": true}},
           "y":{"field":"plays","type":"quantitative","title":"Plays","scale":{"zero": true, "nice": true}},
           "color":{"field":"state","type":"nominal","legend":null},
           "tooltip":[{"field":"state"},{"field":"listeners"},{"field":"plays"}]
         }},
        {"transform":[{"regression":"plays","on":"listeners"}],
         "mark":{"type":"line","strokeDash":[6,4],"color":"#111827"}}
      ]
    };
    vegaEmbed("#chart5", spec5, {actions:false});

    // 6) Bump chart — FIX: explicit domain and nicer labels
    fetch('tyler_audio_features_aus.json').then(r => r.json()).then(rows => {
      const metrics = ["Danceability","Energy","Valence"];
      const bump = [];
      metrics.forEach(m => {
        const subset = rows.filter(d => d.metric===m).sort((a,b)=>b.value-a.value);
        subset.forEach((d,i)=> bump.push({metric:m, album:d.album, rank:i+1}));
      });
      const spec6 = {
        "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
        "data":{"values": bump},
        "mark":{"type":"line","point":true},
        "encoding":{
          "x":{"field":"metric","type":"ordinal","title":"Feature"},
          "y":{"field":"rank","type":"quantitative","title":"Rank (1 = best)",
               "scale":{"reverse": true, "domain":[1,3]}},
          "color":{"field":"album","type":"nominal","scale": albumColorScale},
          "detail":{"field":"album"},
          "tooltip":[{"field":"album"},{"field":"metric"},{"field":"rank"}]
        }
      };
      vegaEmbed("#chart6", spec6, {actions:false});
    });
  </script>
</body>
</html>

